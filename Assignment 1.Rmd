---
title: "Assignment 1"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include= F}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F )
```

```{r loading libraries}
library(tidyverse)
library(plotly)
library(sf)
library(tigris)
library(leaflet)
library(censusapi)

Sys.setenv(CENSUS_KEY="c8aa67e4086b4b5ce3a8717f59faa9a28f611dab")
```

```{r read files}
years <- 2017:2020
quarters <- 1:4
types <- c("Electric","Gas")
pge_17_to_20_elec_and_gas <- NULL

for (year in years) {
  if (year == 2020) {
    quarters <- 1:2
  }
    for (quarter in quarters) {
      for (type in types) {
        filename <-
          paste0(
            "PGE_",
            year,
            "_Q",
            quarter,
            "_",
            type,
            "UsageByZip.csv"
        )
        print(filename)
        temp <- read_csv(filename)
        pge_17_to_20_elec_and_gas <- bind_rows(pge_17_to_20_elec_and_gas, temp)
        saveRDS(pge_17_to_20_elec_and_gas, "pge_17_to_20_elec_and_gas.rds")
    }
  }
}
```


```{r bay area zips}
ca_counties <- counties("CA", cb=T, progress_bar = F)

bay_county_names <-
  c(
    "Alameda",
    "Contra Costa",
    "Marin",
    "Napa",
    "San Fransisco",
    "San Mateo",
    "Santa Clara",
    "Solano",
    "Sonoma"
  )

bay_counties <-
  ca_counties %>%
  filter(NAME %in% bay_county_names)

usa_zips <-
  zctas(cb = T, progress_bar = F)

bay_zips <-
  usa_zips %>%
  st_centroid() %>%
  .[bay_counties, ] %>%
  st_set_geometry(NULL) %>%
  left_join(usa_zips %>% select(GEOID10)) %>%
  st_as_sf()
```

```{r }
pge_final <-
  pge_17_to_20_elec_and_gas %>%
  filter(CUSTOMERCLASS %in% 
           c(
             "Elec-Residential",
             "Elec-Commercial",
             "Gas-Residential",
             "Gas-Commercial"
           ),
        ZIPCODE %in% bay_zips$ZCTA5CE10) %>%
 group_by(YEAR, MONTH) %>%
 summarize(
    MONTHLYKWH =
      sum(
        TOTALKWH,
        na.rm = T
      ),
    MONTHLYTHM =
      sum(
        TOTALTHM,
        na.rm = T
      )
  ) %>%
  mutate(
    MONTHLYKBTU =
      MONTHLYKWH * 3.412,
      MONTHLYTHM * 999.76,
    na.rm = T
  ) %>%
  mutate(
    MONTHLYKBTU =
      MONTHLYTHM * 999.76,
    na.rm = T
  )
```

